angular.module('aipdatingApp', ['ngRoute']).config(function($routeProvider, $locationProvider) {
  $routeProvider.when('/', {
    templateUrl: '/profile/profile.view.html',
    controller: 'ProfileCtrl',
    controllerAs: 'vm',
    authorize: true
  }).when('/login', {
    templateUrl: '/auth/login/login.view.html',
    controller: 'LoginCtrl',
    controllerAs: 'vm',
  }).when('/register', {
    templateUrl: '/auth/register/register.view.html',
    controller: 'RegisterCtrl',
    controllerAs: 'vm',
  }).when('/profile', {
    templateUrl: '/profile/profile.view.html',
    controller: 'ProfileCtrl',
    controllerAs: 'vm',
    authorize: true
  }).when('/register-success', {
    templateUrl: '/auth/register/register.success.html',
    //controller: 'RegisterCtrl',
    //controllerAs: 'vm',
  }).when('/logout', {
    template: '',
    controller: 'logoutCtrl',
    controllerAs: 'vm'
  }).otherwise('/');

}).run(function($rootScope, $location, $http, authentication) {
  $http.defaults.headers.common['Authorization'] = authentication.getToken();

  $rootScope.$on('$routeChangeStart', function(event, to, from) {
    if(to.authorize === true) {
      to.resolve = to.resolve || {};
      to.resolve.auth = function(authentication) {
        if (authentication.currentUser()) {
            return true;
        }
        throw new AuthenticationError();
      }
    }
  });

  $rootScope.$on('$routeChangeError', function(event, current, previous, error) {
    if (error instanceof AuthenticationError) {
      $location.path("login");
    }
  });

  function AuthenticationError() {
    this.code = 'Authorization Error';
    this.error = 'User must be authorized to view this content';
  };

  AuthenticationError.prototype.constructor = AuthenticationError;
});

// Controller of Profile list view

angular.module('aipdatingApp')
    .controller('ProfileCtrl', function($http, authentication, Weather) {

  // Profile holder
  var vm = this;

  vm.formProfile = {};
  vm.profileEval = [];
  vm.isAdmin = false;

  vm.temperature = 0;
  Weather.getTemperature(function(temperature) {
    vm.temperature = temperature;
  });

  var extended = {
    nickname: "",
    distance: "-",
    match: "No",
    _id: ""
  };

  if(authentication.currentUser().role === "Admin")
     vm.isAdmin = true;

  vm.currentUser = authentication.currentUser().name;
  $http.get('/api/profile/').then(function(res) {
    vm.profiles = res.data;
    // initialise the default evaluation of matches
    vm.profileEval = [];
    for(i = 0; i < vm.profiles.length; i++)
      vm.profileEval.push(extended);
  });

  vm.match = function() {
    var valid =
      vm.formProfile.state &&
      vm.formProfile.age &&
      vm.formProfile.gender;
    if(valid) {
      vm.profileEval = [];

      for(i = 0; i < vm.profiles.length; i++) {
        extended.nickname = vm.profiles[i].nickname;
        extended._id = vm.profiles[i]._id;
        console.log(vm.profiles[i].gender);

        // TODO: NEED TO GET THE FOLLOWING FROM THE WEB SERVER - THE BROWSER HATES THIS CODE]
        // get the distance from the maps web service
        //var origins = vm.formProfile.suburb.replace(" ", "+") + "," + vm.formProfile.state;
        //var destinations = vm.profiles[i].suburb.replace(" ", "+") + "," + vm.profiles[i].state;
        //var url = "https://maps.googleapis.com/maps/api/distancematrix/json?units=imperial&" +
        //  "origins=" + origins + "&destinations=" + destinations;
        //$.getJSON(url, function(data) {
        //		console.log(data);
        //	});
        extended.distance = "TBD";  // not supported yet

        // evaluate the match
        if(vm.formProfile.state != vm.profiles[i].state)
          extended.match = "Wrong state";
        else if(vm.formProfile.gender == vm.profiles[i].gender)
          extended.match = "Wrong gender";
        else if(Math.abs(vm.formProfile.age - vm.profiles[i].age) > 10)
          extended.match = "Age gap.";
        else
          extended.match = "YES!!!";

        // add to the bound list data
        vm.profileEval.push(extended);
      }
    }
    else
      window.alert("Please fill in the state, age and gender fields.");
  }

  vm.clear = function() {
    vm.formProfile = {};
  }

  vm.isOwner = function(profile) {
    return profile.user === authentication.currentUser()._id
  }

  //This function will handle both of ADD and EDIT operation after checking the current
  //existing ID
  vm.submit = function() {
    //Split between Add or Edit operation
    //Add new profile

    if(!vm.formProfile._id) {
      //Check "Male" radio button for default
      if(vm.formProfile.gender == null){
        vm.formProfile.gender = "Male";
      }

      var newProfile = {
        nickname: vm.formProfile.nickname,
        age: vm.formProfile.age,
        interest: vm.formProfile.interest,
        suburb: vm.formProfile.suburb,
        state: vm.formProfile.state,
        gender: vm.formProfile.gender
      };

      //attempt to add new profile first
      vm.profiles.push(newProfile);
      //Database call: then call http.post to add into database
      $http.post('/api/profile/', newProfile).then(
        function(res) {
          vm.profiles[vm.profiles.length - 1]._id = res.data.profile._id;
          vm.profiles[vm.profiles.length - 1].user = res.data.profile.user._id;
        },
        function(res) {
          //If fail to update, then roll back
          vm.profiles.pop();
        }
      );
    }
    else {
      //Edit existing profile
      //Backup before executing the operation
      var backup = vm.profiles;

      //Local view update: update the current local data with the new updated item
      vm.profiles = vm.profiles.map(function(profile) {
          if(profile._id === vm.formProfile._id) {
              return {
                nickname: vm.formProfile.nickname,
                age: vm.formProfile.age,
                suburb: vm.formProfile.suburb,
                state: vm.formProfile.state,
                interest: vm.formProfile.interest,
                gender: vm.formProfile.gender,
                user: vm.formProfile.user,
                _id: vm.formProfile._id
              };
          }
          return profile;
      });

      //Database call: call http.put to update into database
      $http.put('/api/profile/' + vm.formProfile._id, {
        nickname: vm.formProfile.nickname,
        age: vm.formProfile.age,
        interest: vm.formProfile.interest,
        suburb: vm.formProfile.suburb,
        state: vm.formProfile.state,
        gender: vm.formProfile.gender
      }).then(
        function(res) {
          //successful
        },
        function(err) {
          //error returned from server
          vm.profiles = backup;
        }
      );
    }
    //Clear the form after finishing operation
    vm.clear();
    vm.isEdit = false;
  }

  //This function to delete the item in the database
  vm.delete = function(index) {
      //Backup before executing the operation
      var backup = vm.profiles;
      var deleteId = vm.profiles[index]._id;
      vm.profiles = vm.profiles.filter(function(profile, profileIndex) {
          return index !== profileIndex;
      });
      $http.delete('/api/profile/'+ deleteId).then(function(res) {
      }, function(res) {
          //If fail to update, roll back
          vm.profiles = backup;
      });
  }

  //This function is used to move the chosen item data into the form
  vm.edit = function(index) {
    console.log("vm edit is call");
      vm.isEdit = true;
      var editProfile = vm.profiles[index];
      vm.formProfile = {
          nickname: editProfile.nickname,
          age: editProfile.age,
          suburb: editProfile.suburb,
          state: editProfile.state,
          interest: editProfile.interest,
          gender: editProfile.gender,
          user: editProfile.user,
          _id: editProfile._id
      }
  }

  vm.close = function() {
    vm.isEdit = false;
  }
});

// Controller for Login view
angular.module('aipdatingApp')
  .controller('LoginCtrl', function($location, authentication) {
    var vm = this;
    vm.formLogin = {};

    /**
     * Send the credentials to the server for authentication
     * @return none
     */
    vm.submit = function (isValid) {
      console.log(isValid);
      if(isValid) {
        authentication.login(vm.formLogin).then(
          function() {
            //Redirect to profile page at login success
            $location.path('profile');
          },
          function (err) {
            vm.error = err.data.error;
          }
        );
      }
    };
  });

// Controller of Log Out function
angular.module('aipdatingApp').controller('logoutCtrl', function($location,authentication) {
  authentication.logOut();
  $location.path('login');
});

// Controller of Resgister view
angular.module('aipdatingApp')
  .controller('RegisterCtrl', function($location, authentication) {
    var vm = this;
    vm.registrationForm = {};

    vm.submit = function(isValid) {
      if(isValid) {
        authentication.register(vm.registrationForm).then(
          function() {
            console.log('register right');
            $location.path('register-success');
          },
          function (err) {
            vm.error = err.data.error;
          }
        );
      }
    }
  });

// Authentication service for front-end:
// Check current status
// Setup Log in state

angular.module('aipdatingApp').service('authentication', function($http, $window) {
  var user = null;
  var token = null;
  var payload = null;

  function getUser() {
    return user;
  };

  function getToken() {
    return $window.localStorage['aip-token'];
  };

  function isTokenValid(token) {
    return (token.exp > Date.now() / 1000);
  };

  function getUserInfo(payload) {
    return {
      _id: payload._id,
      email: payload.email,
      name: payload.name,
      role: payload.role
    }
  }


  function storeToken(payload, token) {
    $window.localStorage['aip-token'] = token;
    user = getUserInfo(payload);
    reset();
  }

  function clearToken() {
    $window.localStorage['aip-token'] = "";
    user = null;
    reset();
  }

  function login(candidateUser) {
    return $http.post('/auth/login', candidateUser).then(
      function(res) {
        storeToken(res.data.user, res.data.token);
      }
    );
  }

  function register(user) {
    return $http.post('/auth/register', user).then(
      function(res) {
        storeToken(res.data.user, res.data.token);
      }
    );
  }

  function reset() {
    token = getToken();
    if(token) {
      payload = token.split('.')[1];
      payload = $window.atob(payload);
      payload = JSON.parse(payload);

      if(isTokenValid(payload)) {
        user = getUserInfo(payload);
      };
    };
    $http.defaults.headers.common['Authorization'] = getToken();

  };

  reset();

  return {
    currentUser: getUser,
    getToken: getToken,
    login: login,
    register: register,
    logOut: clearToken,
  };
});

angular.module('aipdatingApp').service('Weather', function($http, $timeout) {
  function getTemperature(callback) {
    return $http.get('/api/weather/temperature').then(function(res) {
      callback(Math.round((res.data.temperature - 32)*5/9));
    })
  }

  return {
    getTemperature: getTemperature
  };
});

//# sourceMappingURL=app.min.js.map
